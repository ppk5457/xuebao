<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<title>首页</title>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/zoom/flexible.js"></script>
		<link rel="stylesheet" href="css/imgload.css" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			ul,
			li {
				list-style: none;
				margin: 0;
				padding: 0;
			}
			
			.title {
				margin: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
			}
			/*顶部导航条*/
			
			.mui-bar .mui-pull-left .mui-icon {
				padding-right: 5px;
				font-size: 28px;
			}
			
			.mui-bar .mui-btn {
				font-weight: normal;
				font-size: 17px;
			}
			
			.mui-bar .mui-btn-link {
				top: 1px;
			}
			
			.mui-content{
				background-color: rgb(240, 240, 240);
			}
			
			.mui-content img {
				width: 100%;
			}
			
			#img1 {
				width: 100%;
			}
			
			.hm-description {
				margin: 15px;
			}
			
			.hm-description>li {
				font-size: 14px;
				color: #8f8f94;
			}
			/*头部样式修改*/
			
			.mui-bar {
				display: flex;
				justify-content: space-around;
				align-items: center;
				background-color: rgba(77, 169, 239, 0);
			}
			
			.mui-bar img {
				width: 100%;
				height: 100%;
			}
			
			.head_location {
				width: 0.41666rem;
				height: 0.581111rem;
			}
			
			.head_location img {
				width: 100%;
				height: 100%;
			}
			
			.search_input {
				width: 75%;
				border-radius: 24px;
				color: #FFFFFF;
				font: "microsoft yahei";
				text-align: left;
				padding: 5px 0;
				padding-left: 10%;
				background-color: rgba(255, 255, 255, 0.4);
				z-index: 99;
				position: relative;
			}
			
			.search_input img {
				width: 15px;
				height: 15px;
				position: absolute;
				left: 5%;
				top: 9px;
			}
			
			.receive_infor_btn {
				width: 0.575rem;
				height: 0.575rem;
				position: relative;
			}
			
			.receive_infor_btn img {
				width: 100%;
				height: 100%;
			}
			/*轮播图*/
			
			.mui-slider {
				width: 100%;
				min-height: 5.555555rem;
				max-height: 6.944444rem;
			}
			
			.mui-slider-indicator {
				bottom: 24px;
			}
			/*课程表*/
			
			.course_box {
				display: flex;
				position: relative;
				width: 98%;
				margin: 0 auto;
				margin-top: -13px;
				padding: 0;
				height: 3.333333rem;
				justify-content: space-around;
				z-index: 9;
			}
			
			.course {
				width: 49.5%;
				height: 3.333333rem;
			}
			
			.course img {
				width: 100%;
				height: 100%;
			}
			
			.recommend {
				width: 49.5%;
			}
			
			.recommend_top {
				width: 100%;
				height: 1.652777rem;
				margin-bottom: 0.027777rem;
			}
			
			.recommend_top img {
				width: 100%;
				height: 100%;
			}
			
			.recommend_bottom {
				width: 100%;
				height: 1.652777rem;
			}
			
			.recommend_bottom img {
				width: 100%;
				height: 100%;
			}
			/*服务消息*/
			
			.serve_nav {
				width: 100%;
				height: 1.063888rem;
				border-bottom: 1px solid rgba(220, 220, 220, .5);
				display: flex;
				align-items: center;
				background-color: rgba(255, 255, 255, 1);
				margin-top: 0.222222rem;
			}
			
			.nav_line {
				width: 3px;
				background-color: #007AFF;
				height: 0.436666rem;
				margin-left: 5%;
			}
			
			.nav_serve {
				width: 70%;
				margin-top: 0.128888rem;
				margin-left: 0.163333rem;
				color: rgba(136, 136, 136, 1);
				font-size: 0.388888rem;
			}
			
			.nav_more {
				width: 30%;
				text-align: right;
				padding-right: 5%;
				color: rgba(136, 136, 136, 1);
			}
			
			.class_message {
				width: 100%;
				background-color: rgba(255, 255, 255, 1);
				margin-bottom: 0.111111rem;
			}
			
			.class_message:active {
				background-color: rgb(240, 240, 240);
			}
			
			.message_title {
				display: flex;
				padding: 0.222222rem 5%;
				align-items: center;
			}
			
			.title_img {
				width: 0.75rem;
				height: 0.75rem;
			}
			
			.title_img img {
				width: 100%;
				height: 100%;
			}
			
			.title_text {
				padding-left: 0.388888rem;
				font-size: 0.416666rem;
				color: rgb(51, 51, 51);
			}
			
			.title_time {
				color: rgba(136, 136, 136, 1);
				padding-left: 0.222222rem;
				font-size: 0.277777rem;
			}
			
			.message_body {
				width: 100%;
				padding-bottom: 0.388888rem;
				display: flex;
				justify-content: space-between;
				color: rgba(136, 136, 136, 1);
			}
			
			.body_choose {
				color: rgba(85, 85, 85, 1);
				font-size: 0.388888rem;
				margin-left: 5%;
				padding-left: 1.138rem;
			}
			
			.body_detail {
				color: rgb(136, 136, 136);
				font-size: 0.277777rem;
				padding-right: 5%;
				display: inline-flex;
				align-items: center;
			}
			
			.body_detail>img {
				width: 0.166666rem;
				height: 0.152777rem;
				margin-left: 0.057777rem;
			}
			/*老师动态*/
			
			.teacher_box {
				background-color: rgba(255, 255, 255, 1);
				padding: 3%;
				padding-bottom: 65px;
			}
			
			.teacher_ul {
				display: flex;
				justify-content: space-between;
				width: 100%;
				flex-wrap: wrap;
			}
			
			.teacher_ul li {
				width: 48%;
			}
			
			.teacher_cover {
				width: 100%;
				height: 3.333333rem;
			}
			
			.teacher_cover img {
				width: 100%;
				height: 100%;
			}
			
			.teacher_list {
				display: flex;
				align-items: center;
				width: 100%;
				margin: 0.122222rem 0;
			}
			
			.teacher_img {
				width: 10%;
			}
			
			.teacher_img img {
				width: 0.333333rem;
				height: 0.333333rem;
				border-radius:90px;
			}
			
			.teacher_name {
				padding-left: 0.111111rem;
				padding-top: 0.087444rem;
				width: 60%;
				font-size: 0.277777rem;
				color: rgba(136, 136, 136, 1);
			}
			
			.teacher_message {
				width: 40%;
				text-align: right;
			}
			
			.teacher_message img {
				width: 0.277777rem;
				height: 0.277777rem;
			}
			
			.teacher_message span {
				font-size: 0.277777rem;
				color: rgba(136, 136, 136, 1);
			}
			
			#messRemind {
				position: absolute;
				top: -0.0827777rem;
				right: -0.0827777rem;
				width: 0.277777rem;
				height: 0.277777rem;
				background-color: #f64b2f;
				border-radius: 90px;
				overflow: hidden;
				display: none;
			}
		</style>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-transparent">
			<div class="head_location" id="localtion"><img src="images/index/location.png" /></div>
			<div id="search" class="search_input"><img align="center" src="images/index/search_btn.png" />请输入老师的名字或手机号</div>
			<div class="receive_infor_btn" id="message"><img src="images/index/receive_infor_btn.png" />
				<div id="messRemind"></div>
			</div>
		</header>

		<div class="mui-content" id="msg-content">
			<!--静态图片-->
			<!--<img v-if="sliderBox.num == 1" id="img1" :src="sliderBox.ajaxUrl+item.carouselImageUrl" />-->
			<!--轮播图片-->
			<div id="slider" class="mui-slider">
				<!--<img src="images/cbd.jpg" />-->
			</div>

			<!--课程表-->
			<div class="course_box">
				<div class="course" id="course"><img src="images/index/arrangement.png" /></div>
				<div class="recommend">
					<div class="recommend_top" id="login">
						<img align="center" src="images/index/recommand_1.png" />
					</div>
					<div class="recommend_bottom">
						<img align="center" src="images/index/recommand_2.png" />
					</div>
				</div>
			</div>

			<!--服务消息-->
			<div class="serve_nav">
				<div class="nav_line"></div>
				<span class="nav_serve">服务消息</span>
				<div id="server_more" class="nav_more">更多</div>
			</div>
			<div class="class_message_box" id="class_message_box">
				<div v-for="item in serverArr" class="class_message" v-if="item.type!=13 || item.type!=14" :data-type="item.type | serverType" :data-detailId="item.detailId" :data-typeNew="item.type" :data-id="item.id">
					<div class="message_title">
						<div class="title_img"><img src="images/index/icon_ddxx_shouye.png" /></div>
						<div class="title_text" v-text="item.desc"></div>
						<div class="title_time">{{item.time | dateTime}}</div>
					</div>
					<div class="message_body">
						<div class="body_choose" v-text="item.message"></div>
						<div class="body_detail">查看详情  <img src="images/index/look_detail_icon.png"/></div>
					</div>
				</div>
			</div>
			<!--老师动态-->
			<div class="serve_nav">
				<div class="nav_line"></div>
				<span class="nav_serve">老师动态</span>
				<div v-if="teacherArr" id="teacher_dynamic" class="nav_more">更多</div>
			</div>

			<div class="teacher_box" v-if="teacherArr">
				<ul class="teacher_ul">
					<li class="teacher_li" v-for="(item, index) in teacherArr" v-if="index < 6">
						<a href="javascript:;" @tap="open_detail(item)">
							<div class="teacher_cover">
								<img class="img_cover" v-if="item.images" src="images/status/failed_chos_place_picture.png" onload="indexCoverArrImg(this,vm.teacherArr)" />
							</div>
							<div class="teacher_list">
								<div class="teacher_img">
									<img class="img_cover" align="center" v-if="item.teacherImage" src="images/status/not_login_head.png" onload="indexAvatarArrImg(this,vm.teacherArr)" />
								</div>
								<div class="teacher_name" v-text="item.userName"></div>
								<div class="teacher_message">
									<img align="center" src="images/index/chat_num.png" />
									<span v-text="item.comments.length==0?'0':item.comments.length"></span>
								</div>
							</div>
						</a>
					</li>
				</ul>
			</div>

			<!--取出加密值-->
			<input type="text" style="visibility:hidden" id="getPassword" value="" />
		</div>
		<!--沉浸式适配-->
		<script type="text/javascript" src="js/immersed.js"></script>
		<!--原生渲染插件-->
		<script src="js/util.js"></script>
		<!--引入环信SDK-->
		<script type="text/javascript" src="js/IM/webim.config.js"></script>
		<script type="text/javascript" src="js/IM/strophe-1.2.8.min.js"></script>
		<script type="text/javascript" src="js/IM/websdk-1.4.13.js"></script>
		<!--end-->
		<script type="text/javascript" src="js/config.js"></script>
		<script type="text/javascript" src="js/login_config.js"></script>
		<script type="text/javascript" src="js/vue.min.js"></script>
		<script type="text/javascript" src="js/md5.min.js"></script>
		<script type="text/javascript" src="js/imgload2.js"></script>
		<script type="text/javascript" src="js/storage/websql.js"></script>
		<script type="text/javascript" src="js/hmac-sha1.js"></script>
		<script type="text/javascript" src="js/IM/message.js" ></script>
		<script type="text/javascript" src="js/ajax.js"></script>
		<script type="text/javascript" src="js/index.js" ></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
			mui.plusReady(function() {
				var self = plus.webview.currentWebview(),
					leftPos = Math.ceil((window.innerWidth - 60) / 2); // 设置凸起大图标为水平居中
				/**
				 * drawNativeIcon 绘制带边框的半圆，
				 * 	 id为iconBg的图片
				 *   
				 */
				var drawNativeIcon = util.drawNative('icon', {
					bottom: '18px',
					left: leftPos + 'px',
					width: '60px',
					height: '60px'
				}, [{
					tag: 'img',
					id: 'iconBg',
					src: 'images/index/chos_subj.png',
					position: {
						top: '5px',
						left: '5px',
						width: '50px',
						height: '50px'
					}
				}]);
				// append 到父webview中
				self.append(drawNativeIcon);

				//自定义监听图标点击事件
				drawNativeIcon.addEventListener('click', function(e) {
					shareWebview();
				});

				// 创建子webview窗口 并初始化
				var aniShow = {};
				util.initSubpage(aniShow);

				var nview = plus.nativeObj.View.getViewById('tabBar'),
					activePage = plus.webview.currentWebview(),
					targetPage,
					subpages = util.options.subpages,
					pageW = window.innerWidth,
					currIndex = 0;

				/**
				 * 根据判断view控件点击位置判断切换的tab
				 */
				nview.addEventListener('click', function(e) {
					var clientX = e.clientX;
					if(clientX > parseInt(pageW * 0.1) && clientX <= parseInt(pageW * 0.3)) {
						currIndex = 0;
					} else if(clientX > parseInt(pageW * 0.7) && clientX <= parseInt(pageW * 0.9)) {
						currIndex = 1;
					}
					// 匹配对应tab窗口	
					if(currIndex > 0) {
						targetPage = plus.webview.getWebviewById(subpages[currIndex - 1]);
					} else {
						targetPage = plus.webview.currentWebview();
					}

					if(targetPage == activePage) {
						return;
					}

					//底部选项卡切换
					util.toggleNview(currIndex);
					// 子页面切换
					util.changeSubpage(targetPage, activePage, aniShow);
					//更新当前活跃的页面
					activePage = targetPage;
				});

				/**
				 *选课窗口
				 */
				var sharew;

				function shareWebview() {
					if(sharew) { // 避免快速多次点击创建多个窗口
						mui.openWindow({
							url: 'mask.html',
							id: 'mask',
							show: {
								aniShow: 'fade-in'
							},
							waiting: {
								autoShow: false
							}
						});
						return;
					}
					var href = "mask.html";
					sharew = plus.webview.create(href, "mask.html", {
						width: '100%',
						height: '100%',
						top: '0',
						scrollIndicator: 'none',
						scalable: false,
						popGesture: 'none'
					});
					sharew.addEventListener("loaded", function() {
						sharew.show('fade-in', 300);
					}, false);
				}

				closeSharew();

				function closeSharew() {
					//避免出现特殊情况，确保分享页面在初始化时关闭 
					if(!sharew) {
						sharew = plus.webview.getWebviewById("mask.html");
					}
					if(sharew) {
						sharew.close();
						sharew = null;
					}
				}

				//环信相关配置及消息处理 
				var state = app.getState();
				//环信相关
				message();
				//轮播图
				slider_box();
				//教师动态相关数据处理（vue渲染）
				teacherData();			
				//监听个推消息
				push();
				//更新个推
				updateClient();
				//服务消息
				getServerMess();
				//登录状态检测 
				if(!state || !state.data){
					openView.incView('login/login.html', 'login', '欢迎登陆');
				}
				//监听登录刷新
				window.addEventListener('showView',function(event){
				   //更新教师详情
				   teacherData();
				   //更新轮播
				   slider_box();
				   //更新个推
				   updateClient();
				   //服务消息
					getServerMess();
				});
				//聊天列表
				document.getElementById("message").addEventListener('tap', function() {
					plus.nativeUI.toast('此功能尚未开通~');
//					openView.nativeView('im/msg_list.html', 'msg_list', '消息列表');
					messRemind.style.display = 'none';
				});
				//日历
				document.getElementById("course").addEventListener('tap', function() {
					openView.nativeView('pages_index/calendar.html', 'calendar', '日历', '', 'none');
				});
				//更多服务消息
				document.getElementById("server_more").addEventListener('tap', function() {
					openView.nativeView('pages_index/server_list.html', 'server_list', '服务消息');
				});
				//跟多老师动态
				document.getElementById("teacher_dynamic").addEventListener('tap', function() {
					openView.nativeView('pages_index/more_dynamic.html', 'more_dynamic', '更多动态');
				});
				//搜索
				document.getElementById("search").addEventListener('tap', function() {
					openView.usuView('im/im_search.html', 'im_search');
				});
				//定位
				document.getElementById("localtion").addEventListener('tap', function() {
					openView.nativeView('pages_index/localtion.html', 'localtion', '位置');
				});
				//轮播图平台
				document.getElementById("slider").addEventListener('tap',function(){
					openView.nativeView('pages_setting/platform_list.html', 'platform_list', '平台资料');
				})
				//服务消息
				mui('#class_message_box').on('tap','.class_message',function(){
					var type = this.getAttribute('data-type');
					var sid = this.getAttribute('data-id');
					var detailId = this.getAttribute('data-detailId');
					var typeNew = this.getAttribute('data-typeNew');
					switch(type)
						{
						case '1':
//							openView.nativeView('in_class.html', 'in_class', '上课中',{sid:sid});
							openView.nativeView('pages_index/classroom_detail.html', 'classroom_detail', '课堂反馈',{sid:sid,type:'服务列表'});
							break;
						case '2':
							openView.nativeView('pages_index/pay_success.html', 'pay_success', '充值成功',{sid:sid});
							break;
						case '3':
							chooseCourse(sid,detailId);
							
							break;
						case '4':
							openView.nativeView('pages_index/Withdrawal_success.html', 'Withdrawal_success', '提现成功',{sid:sid});
							break;
						case '5':
							openView.nativeView('pages_index/course_remind.html', 'course_remind', '上课提醒',{sid:sid});
							break;
						case '6':
//							plus.nativeUI.toast('此功能尚未开通~');
							openView.nativeView('pages_index/course_arrangement.html', 'course_arrangement', '课程安排',{sid:sid});
							break;
						case '7':
							openView.nativeView('pages_index/indent_succ.html', 'indent_succ', '订单信息',{sid:sid,typeNew:typeNew});
						break;
						case '8':
							openView.nativeView('pages_index/indent_detail.html', 'indent_detail', '订单详情',{sid:sid});
						break;
						default:		
						}
					});
				
				function chooseCourse(sid,detailId){
					//推送的课堂反馈，需先查到课程id
				    if(sid){
				    	var ajaxData = {
							url:'restful1/message/getServiceMessageById',
							data: {
								id:sid,
							},
							type:'post'
						}
						ajax(ajaxData, function(data) {
							console.log(JSON.stringify(data))
								if(data.code == 200){
									//判断是否填写课堂反馈，如果反馈，查看信息，若未反馈，填写反馈
									if(data.data.feedback){
										var courseDetail = data.data;
										openView.nativeView('pages_index/classroom_detail.html', 'classroom_detail', '课堂反馈',{courseDetail:courseDetail,courseSection:detailId});
									}else{
										openView.nativeView('pages_index/fill_feedback.html', 'fill_feedback', '课堂反馈',{sid:sid,courseId:detailId});
									}							
								}else{
									if(data.code){
										plus.nativeUI.toast(data.msg);
									}else{
										plus.nativeUI.toast(data.err);
									}
								}
						},true);
				    }
					
				}
			});
			Vue.filter('serverType',function(value){
				switch (value){
					case 11:
						return 1;
						break;
					case 12:
						return 5;
						break;
					case 13:
						return 6;
						break;
					case 14:
						return 6;
						break;
					case 15:
						return 8;
						break;
					case 21:
						return 2;
						break;
					case 22:
						return 2;
						break;
					case 3:
						return 3;
						break;
					case 41:
						return 4;
						break;
					case 42:
						return 4;
						break;
					case 51:
						return 7;
						break;
					case 52:
						return 7;
						break;
					default:
						break;
				}
			})
			var vm = new Vue({
				el: '#msg-content',
				data: {
					teacherMessage: [], //教师动态数据
					imgUrl:'',
					serverArr:[]
				},
				computed: {
					teacherArr: function () {
						return this.teacherMessage.reverse();
					}
				}
			})
			//老师动态详情
			function open_detail(data) {
				var datas = JSON.stringify(data);
				openView.nativeView('pages_index/dynamic_detail.html', 'dynamic_detail', '动态详情', {
					datas: datas
				});
			}
			function creatSlider(data) {
				var len = data.length;
				// 图片
				var sliderGroup = document.createElement("div");
				sliderGroup.className = "mui-slider-group mui-slider-loop";
				var group = '<div class="mui-slider-item mui-slider-item-duplicate">' +
					'<a href="javascript:;" data-type="' + ajaxUrl + data[len - 1].carouselUrl + '">' +
					'<img src="' + ajaxUrl + data[len - 1].carouselImageUrl + '">' +
					'</a>' +
					'</div>';
				for(var i = 0; i < len; i++) {
					group += '<div class="mui-slider-item">' +
						'<a href="javascript:;" data-type="' + ajaxUrl + data[i].carouselUrl + '">' +
						'<img src="' + ajaxUrl + data[i].carouselImageUrl + '">' +
						'</a>' +
						'</div>';
				}
				group += '<div class="mui-slider-item mui-slider-item-duplicate">' +
					'<a href="javascript:;" data-type = "' + ajaxUrl + data[0].carouselUrl + '">' +
					'<img src="' + ajaxUrl + data[0].carouselImageUrl + '">' +
					'</a>' +
					'</div>';
				sliderGroup.innerHTML = group;

				// 圆点
				var sliderIndicator = document.createElement("div");
				sliderIndicator.className = "mui-slider-indicator";
				for(var i = 0; i < len; i++) {
					var item = document.createElement("div");
					item.className = "mui-indicator";
					if(i == 0) {
						item.classList.add('mui-active');
					}
					sliderIndicator.appendChild(item);
				}

				var slider = document.getElementById('slider');
				slider.appendChild(sliderGroup);
				slider.appendChild(sliderIndicator);

				mui("#slider").slider({
					interval: 5000
				});
			}
		</script>
	</body>

</html>